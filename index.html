<html>
<meta charset="utf-8">

<head>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"
    integrity="sha256-Hgwq1OBpJ276HUP9H3VJkSv9ZCGRGQN+JldPJ8pNcUM=" crossorigin="anonymous"></script>
  <script src="build/syncplay.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css"
    integrity="sha256-R91pD48xW+oHbpJYGn5xR0Q7tMhH4xOrWn1QqMRINtA=" crossorigin="anonymous">
  <style>
    body {
      background: wheat;
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    #node {
      margin: 20px;
      padding: 0;
    }

    #fpicker-div {
      background: grey;
      width: 98%;
      height: 96%;
      position: fixed;
      color: wheat;
      text-align: center;
      cursor: pointer;
      border: 15px dashed wheat;
      margin: -10px;
    }

    #fpicker-div>label {
      position: absolute;
      text-align: center;
      font-size: 4em;
      width: 100%;
      top: 40%;
      display: block;
      cursor: pointer;
    }

    input.input-url {
      width: 60%;
    }
  </style>
</head>

<body>
  <div id="input-form">
    <label>
      同步服务:
      <input class="input-url" type="text" name="server-url" id="server-url" value="ws://127.0.0.1:9000/websockify">
    </label> <br>
    <label>视频地址:
      <input class="input-url" id="video-src" type="text" value="http://10.240.129.116/full-h264_amf-1920x806.mp4" />
    </label> <br>
    或本地文件: <input id="fpicker" type="file" accept="video/*,audio/*" /><br>
    <label>用户名:
      <input id="username" type="text" value="User1" />
    </label>
    <label>房间名:
      <input id="room" type="text" value="Test" />
    </label>
    <button onclick="start()">确认</button> <br>
  </div>
  <div id="manage"></div>
  <video id="node" controls="true"></video>
  <script>
    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "showDuration": "30",
      "hideDuration": "1000",
      "timeOut": "2000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    function pick() {
      $("#fpicker").click();
    }
    var vid_player = $("#node")[0];

    var username = $('#username').val();

    function formatDuration(value) {
      var sec_num = parseInt(value, 10); // don't forget the second param
      var hours = Math.floor(sec_num / 3600);
      var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
      var seconds = sec_num - (hours * 3600) - (minutes * 60);

      if (hours < 10) { hours = "0" + hours; }
      if (minutes < 10) { minutes = "0" + minutes; }
      if (seconds < 10) { seconds = "0" + seconds; }
      return hours + ':' + minutes + ':' + seconds;
    }

    function start() {
      var target = $("#fpicker")[0].files[0];
      var src = $('#video-src').val();
      console.log('target', target, 'src', src)
      if (!target && !src) {
        toastr.error('未提供视频文件或Url!')
        return;
      }
      if (target) {
        $("#node").attr("src", window.URL.createObjectURL(target));
        window.filename = target.name;
        window.filesize = target.size;
      } else {
        $("#node").attr("src", src);
        window.filename = src;
        window.filesize = null;
      }
      document.title = '同步播放 - ' + $('#username').val();
    }
    vid_player.volume = 0.3;
    $(vid_player).on("loadeddata", function (e) {
      console.debug('handle', 'loadeddata', e.detail);
      $("#fpicker-div").hide();
      $("#node").show();
      toastr.info(`视频文件读取成功(${formatDuration(vid_player.duration)}): ${filename}`);
      function onconnect(e) {
        if (e.connected) {
          toastr.success("已连接到服务器!");
          syncplayjs.set_file(filename, vid_player.duration, filesize);
        }
      }
      function onerror(e) {
        toastr.error("同步服务器连接失败!");
      }
      if (window.syncplayjs) {
        syncplayjs.disconnect();
        syncplayjs = null;
      }

      window.syncplayjs = new SyncPlay(vid_player, {
        name: $('#username').val(),
        room: $('#room').val(),
        url: $('#server-url').val()
      }, onconnect, onerror);
      syncplayjs.connect();
    });

    $(vid_player).on("listusers", function (e) {
      console.debug('handle', 'listusers', e.detail);
      $('#manage').text(JSON.stringify(e.detail));
      var seekFromEvent = true;
      for (var i = 0; i < Object.keys(e.detail).length; i++) {
        var user = Object.keys(e.detail)[i];
        if (user == username) {
          continue;
        }
        var filename = e.detail[user].file.name;
        var filesize = e.detail[user].file.size; // bytes
        var file_duration = e.detail[user].file.duration; // seconds
      }
    });

    $(vid_player).on("userlist", function (e) {
      console.debug('handle', 'userlist', e.detail);
      var user = e.detail.user;
      var user_event = e.detail.evt;
      toastr.info("'" + user + "' " + user_event);
      // Pause when other user left.
      if (user_event === 'left') {
        vid_player.pause();
      }
    });

    window.seekFromEvent = false;

    $(vid_player).on("seeked", function (e) {
      console.debug('handle', 'seeked', e.detail)
      if (!window.seekFromEvent) {
        syncplayjs.seeked();
      }
      window.seekFromEvent = false;
    });

    $(vid_player).on("fileupdate", function (e) {
      console.debug('handle', 'fileupdate', e.detail);
      var names = Object.keys(e.detail.user);
      for (var name of names) {
        if (name === username) {
          continue;
        }
        var info = e.detail.user[name].file;
        toastr.info(`'${name}' 选择了文件(${formatDuration(info.duration)}): ${info.name}`);
      }
    });

    $(vid_player).on("userevent", function (e) {
      console.debug('handle', 'userevent', e.detail)
      var username = e.detail.setBy;
      var position = e.detail.position;
      var paused = e.detail.paused;
      var doSeek = e.detail.doSeek

      if (!paused && vid_player.paused) {
        var message = "'" + username + "' resumes at " + formatDuration(position);
        vid_player.currentTime = e.detail.position;
        vid_player.play();
        toastr.info(message);
      }
      if (paused && !vid_player.paused) {
        var message = "'" + username + "' paused at " + formatDuration(position);
        vid_player.pause();
        toastr.info(message);
      }
      if (doSeek == true) {
        var message = "'" + username + "' seeked to " + formatDuration(position);
        window.seekFromEvent = true;
        vid_player.currentTime = e.detail.position;
        toastr.warning(message);
      }
    });

    $(vid_player).on("play", function (e) {
      console.debug('handle', 'play', e.detail)
      syncplayjs.playPause();
    });

    $(vid_player).on("pause", function (e) {
      console.debug('handle', 'pause', e.detail)
      syncplayjs.playPause();
    });

    $(vid_player).on("namechange", function (e) {
      console.debug('handle', 'namechange', e.detail)
      username = e.detail.username;
      $('#username').val(username);
      toastr.info(`用户名被修改为: '${username}'`);
    });
  </script>
</body>

</html>