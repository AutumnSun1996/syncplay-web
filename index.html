<html>
<meta charset="utf-8">

<head>
  <script src="build/syncplay.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
</head>

<body>
  <style>
    body {
      background: wheat;
    }

    #node {
      width: 100%;
      margin: 0;
      padding: 0;
    }

    #fpicker-div {
      background: grey;
      width: 98%;
      height: 96%;
      position: fixed;
      color: wheat;
      text-align: center;
      cursor: pointer;
      border: 15px dashed wheat;
      margin: -10px;
    }

    #fpicker-div>label {
      position: absolute;
      text-align: center;
      font-size: 4em;
      width: 100%;
      top: 40%;
      display: block;
      cursor: pointer;
    }
  </style>
  <input id="fpicker" type="file" accept="video/*,audio/*" /><br>
  <label>(或)输入视频链接:
    <input id="video-src" type="text" style="width: 60%;" />
  </label> <br>
  <label>输入用户名:
    <input id="username" type="text" value="User1" />
  </label>
  <label>输入房间名:
    <input id="room" type="text" value="Violet" />
  </label>
  <button onclick="start()">确认</button> <br>
  <video id="node" controls="true" style="display: none;"></video>
  <script>
    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "showDuration": "30",
      "hideDuration": "1000",
      "timeOut": "2000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    function pick() {
      $("#fpicker").click();
    }
    var vid_player = $("#node")[0];

    var username = $('#username').val();

    function start() {
      var target = $("#fpicker")[0].files[0];
      var src = $('#video-src').val();
      console.log('target', target, 'src', src)
      if (!target && !src) {
        toastr.error('No file or url provided!')
        return;
      }
      if (target) {
        $("#node").attr("src", window.URL.createObjectURL(target));
        window.filename = target.name;
        window.filesize = target.size;
      } else {
        $("#node").attr("src", src);
        window.filename = src;
        window.filesize = null;
      }
      document.title = '同步播放 - ' + $('#username').val();
    }
    vid_player.volume = 0.3;
    $(vid_player).on("loadeddata", function (e) {
      console.log('loadeddata');
      $("#fpicker-div").hide();
      $("#node").show();

      function onconnect(e) {
        if (e.connected) {
          toastr.success("Connected!");
          syncplayjs.set_file(filename, vid_player.duration, filesize);
        }
      }
      if (window.syncplayjs) {
        syncplayjs.disconnect();
        syncplayjs = null;
      }

      window.syncplayjs = new SyncPlay({
        name: $('#username').val(),
        room: $('#room').val() || "Violet",
        url: "ws://127.0.0.1:9000/websockify"
      }, onconnect, vid_player);
      var getterFn = {
        is_paused: function (vid_player) {
          return vid_player.paused;
        },
        get_position: function (vid_player) {
          return vid_player.currentTime;
        }
      };
      syncplayjs.setStateGetters(getterFn, vid_player);
      syncplayjs.connect();
    });

    $(vid_player).on("listusers", function (e) {
      syncplayjs.seeked();
      for (var i = 0; i < Object.keys(e.detail).length; i++) {
        var user = Object.keys(e.detail)[i];
        if (user == username) {
          continue;
        }
        var filename = e.detail[user].file.name;
        var filesize = e.detail[user].file.size; // bytes
        var file_duration = e.detail[user].file.duration; // seconds
      }
    });

    $(vid_player).on("userlist", function (e) {
      console.log('Handle', e, e.detail)
      var user = e.detail.user;
      var user_event = e.detail.evt;
      toastr.info("'" + user + "' " + user_event);
      // Pause when other user left.
      if (user_event === 'left') {
        vid_player.pause();
      }
    });

    window.seekFromEvent = false;

    $(vid_player).on("seeked", function (e) {
      if (!window.seekFromEvent) {
        syncplayjs.seeked();
      }
      window.seekFromEvent = false;
    });

    $(vid_player).on("fileupdate", function (e) {
      var username = Object.keys(e.detail.user);
      var file = e.detail.user[username].file;
      var duration = file.duration; // seconds
      var filename = file.name;
      var filesize = file.size; // bytes
    });

    $(vid_player).on("userevent", function (e) {
      var username = e.detail.setBy;
      var position = e.detail.position;
      var paused = e.detail.paused;
      var doSeek = e.detail.doSeek

      if (!paused && vid_player.paused) {
        var message = "'" + username + "' resumes at " + position;
        vid_player.currentTime = e.detail.position;
        vid_player.play();
        toastr.info(message);
      }
      if (paused && !vid_player.paused) {
        var message = "'" + username + "' paused at " + position;
        vid_player.pause();
        toastr.info(message);
      }
      if (doSeek == true) {
        var message = "'" + username + "' seeked to " + position;
        window.seekFromEvent = true;
        vid_player.currentTime = e.detail.position;
        toastr.warning(message);
      }
    });

    $(vid_player).on("play", function (e) {
      syncplayjs.playPause();
    });

    $(vid_player).on("pause", function (e) {
      syncplayjs.playPause();
    });
  </script>
</body>

</html>